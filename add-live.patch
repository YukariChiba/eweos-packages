From bd20d94ecea2a7bdbd57b0b3b2f1083567e303e5 Mon Sep 17 00:00:00 2001
From: Eudald Gubert i Roldan <hola@eudald.gr>
Date: Sat, 10 Oct 2020 21:55:33 +0200
Subject: [PATCH 1/6] live hooks

---
 hook/live/live      | 17 +++++++++++++++++
 hook/live/live.init | 30 ++++++++++++++++++++++++++++++
 2 files changed, 47 insertions(+)
 create mode 100644 hooks/live/live
 create mode 100644 hooks/live/live.init

diff --git a/hook/live/live b/hook/live/live
new file mode 100644
index 0000000..c7fbd5a
--- /dev/null
+++ b/hook/live/live
@@ -0,0 +1,17 @@
+#!/bin/sh
+#
+# false positive
+# shellcheck disable=2154
+
+cdrom="/usr/lib/modules/$kernel/kernel/drivers/cdrom/cdrom.ko"
+loop="/usr/lib/modules/$kernel/kernel/drivers/block/loop.ko"
+overlay="/usr/lib/modules/$kernel/kernel/fs/overlayfs/overlay.ko"
+squash="/usr/lib/modules/$kernel/kernel/fs/squashfs/squashfs.ko"
+
+for _mod in "$cdrom" "$loop" "$overlay" "$squash"; do
+    copy_kmod "$_mod"
+done
+
+for _bin in blockdev cp losetup umount; do
+    copy_exec "$_bin"
+done
diff --git a/hook/live/live.init b/hook/live/live.init
new file mode 100644
index 0000000..9ad91ec
--- /dev/null
+++ b/hook/live/live.init
@@ -0,0 +1,30 @@
+#!/bin/sh
+#
+# false positive
+# shellcheck disable=2154
+
+modprobe -a cdrom loop overlay squashfs 
+
+medium=/run/initramfs/medium
+system=/run/initramfs/system
+
+mkdir -p "$medium" "$system" /run/initramfs/overlayfs/work /run/initramfs/overlayfs/write
+
+[ -h "/dev/disk/by-$live_disk_type/$live_disk" ] || { sleep 5; }
+
+mount -o ro "/dev/disk/by-$live_disk_type/$live_disk" "$medium" || panic
+
+sfsimg="$medium/$live_img_file"
+
+[ "$ram" ] && {
+    mkdir -p /run/initramfs/ram
+    mount -t tmpfs -o "${live_ram_opts:?}" ram /run/initramfs/ram || panic
+    cp "$sfsimg" /run/initramfs/ram || panic
+    umount "$medium"
+    sfsimg="$ramdir/$live_img_file"
+}
+
+sfsdev=$(losetup -f)
+losetup -f -r "$sfsimg"
+
+mount -t squashfs -o "${live_sfs_opts:-defaults,ro}" "$sfsdev" "$system" || panic

From edcebcf10d0442fcba8c4b4e76cf09253b3081bb Mon Sep 17 00:00:00 2001
From: Eudald Gubert i Roldan <hola@eudald.gr>
Date: Sat, 10 Oct 2020 22:01:15 +0200
Subject: [PATCH 2/6] Update live hook

---
 hook/live/live | 7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/hook/live/live b/hook/live/live
index c7fbd5a..9f79fdc 100644
--- a/hook/live/live
+++ b/hook/live/live
@@ -3,12 +3,7 @@
 # false positive
 # shellcheck disable=2154
 
-cdrom="/usr/lib/modules/$kernel/kernel/drivers/cdrom/cdrom.ko"
-loop="/usr/lib/modules/$kernel/kernel/drivers/block/loop.ko"
-overlay="/usr/lib/modules/$kernel/kernel/fs/overlayfs/overlay.ko"
-squash="/usr/lib/modules/$kernel/kernel/fs/squashfs/squashfs.ko"
-
-for _mod in "$cdrom" "$loop" "$overlay" "$squash"; do
+for _mod in cdrom loop overlay squashfs; do
     copy_kmod "$_mod"
 done
 

From 49aebd527eabfb553e91ed774a1e6086c42f6ad1 Mon Sep 17 00:00:00 2001
From: Eudald Gubert i Roldan <hola@eudald.gr>
Date: Sat, 10 Oct 2020 22:54:18 +0200
Subject: [PATCH 3/6] remove shellcheck comment

---
 hook/live/live | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/hook/live/live b/hook/live/live
index 9f79fdc..5833164 100644
--- a/hook/live/live
+++ b/hook/live/live
@@ -1,7 +1,4 @@
 #!/bin/sh
-#
-# false positive
-# shellcheck disable=2154
 
 for _mod in cdrom loop overlay squashfs; do
     copy_kmod "$_mod"

From 20c85f8f9296d36989383f8d1e1ea53bfc1f99e7 Mon Sep 17 00:00:00 2001
From: Eudald Gubert i Roldan <hola@eudald.gr>
Date: Sat, 10 Oct 2020 23:21:27 +0200
Subject: [PATCH 4/6] fix mistake

---
 hook/live/live.init | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hook/live/live.init b/hook/live/live.init
index 9ad91ec..003a6d1 100644
--- a/hook/live/live.init
+++ b/hook/live/live.init
@@ -21,7 +21,7 @@ sfsimg="$medium/$live_img_file"
     mount -t tmpfs -o "${live_ram_opts:?}" ram /run/initramfs/ram || panic
     cp "$sfsimg" /run/initramfs/ram || panic
     umount "$medium"
-    sfsimg="$ramdir/$live_img_file"
+    sfsimg="/run/initramfs/ram/$live_img_file"
 }
 
 sfsdev=$(losetup -f)

From 8470d61e8eb27317f95a068535774b0facd0dcbf Mon Sep 17 00:00:00 2001
From: Eudald Gubert i Roldan <hola@eudald.gr>
Date: Thu, 19 Nov 2020 16:14:49 +0100
Subject: [PATCH 6/6] Improvements

---
 hook/live/live      | 2 +-
 hook/live/live.init | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/hook/live/live b/hook/live/live
index 5833164..1a830b1 100644
--- a/hook/live/live
+++ b/hook/live/live
@@ -1,4 +1,4 @@
-#!/bin/sh
+# vim: set ft=sh:
 
 for _mod in cdrom loop overlay squashfs; do
     copy_kmod "$_mod"
diff --git a/hook/live/live.init b/hook/live/live.init
index 003a6d1..b2e5316 100644
--- a/hook/live/live.init
+++ b/hook/live/live.init
@@ -1,4 +1,4 @@
-#!/bin/sh
+# vim: set ft=sh:
 #
 # false positive
 # shellcheck disable=2154
@@ -10,7 +10,7 @@ system=/run/initramfs/system
 
 mkdir -p "$medium" "$system" /run/initramfs/overlayfs/work /run/initramfs/overlayfs/write
 
-[ -h "/dev/disk/by-$live_disk_type/$live_disk" ] || { sleep 5; }
+[ -h "/dev/disk/by-$live_disk_type/$live_disk" ] || sleep 5
 
 mount -o ro "/dev/disk/by-$live_disk_type/$live_disk" "$medium" || panic
 
